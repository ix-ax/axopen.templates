name: "axosimple"
version: '0.0.0-dev.0'
type: app
targets:
  - plcsim
  # - swcpu 
  # - "1500"
  # - llvm
registries:
  '@ix-ax': https://npm.pkg.github.com/
devDependencies:
  "@ix-ax/ax-sdk": '0.0.0-dev.0'
  #"@ix-ax/ax-sdk": '0.4.3-dev-2311.790'  
  "@ax/st-lang-contrib-library-toolbox": ^0.17.2
dependencies:
  "@ix-ax/axopen.data": '0.0.0-dev.0'
  "@ix-ax/axopen.inspectors": '0.0.0-dev.0'
  "@ix-ax/axopen.components.elements": '0.0.0-dev.0'
  "@ix-ax/axopen.components.pneumatics": '0.0.0-dev.0'
  "@ix-ax/axopen.components.cognex.vision": '0.0.0-dev.0'
  #"@ix-ax/axopen.components.drives": '0.0.0-dev.0'
  #"@ix-ax/axopen.components.rexroth.drives": '0.0.0-dev.0'
  #"@ix-ax/axopen.components.rexroth.press": '0.0.0-dev.0'
  #"@ix-ax/axopen.components.festo.drives": '0.0.0-dev.0'
  #"@ix-ax/axopen.components.abb.robotics": '0.0.0-dev.0'
  #"@ix-ax/axopen.components.mitsubishi.robotics": '0.0.0-dev.0'
  #"@ix-ax/axopen.components.ur.robotics": '0.0.0-dev.0'
  "@ix-ax/axopen.simatic1500": '0.0.0-dev.0'
  # "@ix-ax/axopen.data": '0.4.4-alpha.857'
  # "@ix-ax/axopen.inspectors": '0.4.4-alpha.857'
  # "@ix-ax/axopen.components.elements": '0.4.4-alpha.857'
  # "@ix-ax/axopen.components.pneumatics": '0.4.4-alpha.857'
  # "@ix-ax/axopen.components.cognex.vision": '0.4.4-alpha.857'
  # "@ix-ax/axopen.components.drives": '0.4.4-alpha.857'
  # "@ix-ax/axopen.components.rexroth.drives": '0.4.4-alpha.857'
  # "@ix-ax/axopen.components.rexroth.press": '0.4.4-alpha.857'
  # "@ix-ax/axopen.components.festo.drives": '0.4.4-alpha.857'
  # "@ix-ax/axopen.components.abb.robotics": '0.4.4-alpha.857'
  # "@ix-ax/axopen.components.mitsubishi.robotics": '0.4.4-alpha.857'
  # "@ix-ax/axopen.components.ur.robotics": '0.4.4-alpha.857'
  # "@ix-ax/axopen.simatic1500": '0.4.4-alpha.857'
variables:
  APAX_BUILD_ARGS: [ -d ]
  # Uncomment if you want overrite system variables
  # AXTARGET: 10.10.10.116
  # AXTARGETPLATFORMINPUT: './bin/plcsim/'
scripts:
  ixc:
    - dotnet tool restore --no-cache
    - dotnet ixc
    - dotnet ixr
  postbuild: apax ixc
  push:
    - apax build
    - apax download
  build:
    - apax install
    - apax build
  addunit: |
    while [ -z "$unitname" ]; do
      echo "Enter the unit name (mandatory):"
      echo "ATTENTION: The name must start with upper-case letter, no space and no special characters. The name must comply with legal type name for AX"
      read unitname
    done

    dotnet new install ./src/templates/unit/ --force
    # Execute the dotnet new command with the provided class name
    dotnet new axosimple_unit --unitname=$unitname  -o ./src/$unitname 

    # Move twin files to twin project 
    mkdir -p ../axpansion/twin/Context/Units/
    mv  ./src/$unitname/twin/*.cs ../axpansion/twin/Context/Units/
    rm -rf ./src/$unitname/twin/

    # Move server files to server project 
    mkdir -p ../axpansion/server/Pages/Context/Units/
    mv  ./src/$unitname/server/*.* ../axpansion/server/Pages/Context/Units/
    rm -rf ./src/$unitname/server/
  download:
    # Here you will need to set the argumen -t to your plc IP and -i to platfrom you are dowloading to
    # --default-server-interface is a must if you are using WebAPI          
    - apax sld load -C ../.certs/Communication.cer
      --accept-security-disclaimer -t $AXTARGET -i $AXTARGETPLATFORMINPUT -r
    # - apax sld load --accept-security-disclaimer -t $AXTARGET -i $AXTARGETPLATFORMINPUT -r
  delta:
    # Here you will need to set the argumen -t to your plc IP and -i to platfrom you are dowloading to
    # --default-server-interface is a must if you are using WebAPI 
    - apax build --ignore-scripts
    - apax sld load -C ../.certs/Communication.cer
      --accept-security-disclaimer -t $AXTARGET -i $AXTARGETPLATFORMINPUT --mode
      delta
    # - apax sld load --accept-security-disclaimer -t $AXTARGET -i $AXTARGETPLATFORMINPUT --mode delta
  dcpli: 
    # list all interfaces, used to discover MAC address of the adapter connected to PLC and set the PC_MAC value accordingly
    - apax dcp-utility list-interfaces -f JSON
  dcpd: 
    # list all interfaces, used to discover MAC address of the adapter connected to PLC and set the PC_MAC value accordingly
    - apax dcp-utility discover --source-mac 02:1B:1B:44:47:00 --timeout 10000 # discover all accesible devices connected to adapter with MAC address equal to PC_MAC, used to discover MAC-addresses of the slaves and setting the PLC_MAC,RF186_MAC and ET201_MAC variables
  reset_plc: 
    # list all interfaces, used to discover MAC address of the adapter connected to PLC and set the PC_MAC value accordingly
    - apax hwld -t $AXTARGET --resetPlc KeepOnlyIP --accept-security-disclaimer #total reset of the PLC including IP and name
    
  hw-security-setup: 
    - openssl genpkey -algorithm RSA -out ../.certs/pk.key -pkeyopt rsa_keygen_bits:2048
    - openssl req -new -key ../.certs/pk.key -out ../.certs/csr.csr -subj "//C=US/ST=California/L=San Francisco/O=Your Organization/OU=Your Organizational Unit/CN=www.example.com"    
    - openssl req -x509 -sha256 -days 365 -key ../.certs/pk.key -in ../.certs/csr.csr -out ../.certs/cert.crt 
    - openssl pkcs12 -export -out ../.certs/plc.p12 -inkey ../.certs/pk.key -in ../.certs/cert.crt -certfile ../.certs/cert.crt -passout pass:$AX_TARGET_PWD
       
    # - apax hwc setup-secure-communication -n plc -i "default.hwl.json" -p $AX_TARGET_PWD    
    # - apax hwc import-certificate --name plc --input default.hwl.json --certificate ../.certs/plc.p12 --password $AX_TARGET_PWD --purpose "TLS"
    # - apax hwc import-certificate --name plc --input default.hwl.json --certificate ../.certs/plc.p12 --password $AX_TARGET_PWD --purpose "WebServer"
    # - apax hwc manage-users -n plc -i ./default.hwl.json set-password -u "usr" -p $AX_TARGET_PWD   
  hw-compile-download:    
    - apax hwc compile -i default.hwl.json -o bin/hwc/    
    - apax hwld -i bin/hwc/plc -t $AXTARGET -M:$AX_TARGET_PWD --accept-security-disclaimer -l Information
    - apax plc-cert -t $AXTARGET -o ../.certs/Certificate.cer  

publicKeys:
  "@ix-ax": 30c06ef7830b4dfd8f16e003508da1ac2d187714d0e1f38279a9332cbe4e4e17
installStrategy: overridable
apaxVersion: 3.1.1
